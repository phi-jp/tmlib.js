<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * dom/evnet.js
 */

tm.dom = tm.dom || {};

(function() {
    
<span id='Event'>    /**
</span>     * @class Event
     * 既存のEventオブジェクト拡張
     */
    
    // 仕方なしの IE 対応(これ引っかかったら他のもダメだから必要ないかも)
    if (!Event.prototype.stopPropagation) {
        Event.prototype.stopPropagation = function() {
            this.cancelBubble = true;
        };
    }
    if (!Event.prototype.preventDefault) {
<span id='Event-method-stop'>        Event.prototype.preventDefault = function() {
</span>            this.returnValue = false;
        };
    }
    
    /**
     * @method
     * イベントのデフォルト処理 &amp; 伝達を止める
     */
    Event.prototype.stop = function() {
<span id='KeyboardEvent'>        // イベントキャンセル
</span>        this.preventDefault();
<span id='KeyboardEvent-property-character'>        // イベント伝達を止める
</span>        this.stopPropagation();
    };
    
})();


(function() {
    
    /**
     * @class KeyboardEvent
     * KeyboardEvent クラス
     */
    
    /**
     * @property    character
<span id='MouseEvent'>     * 押したキーの文字を取得
</span>     */
<span id='MouseEvent-property-pointX'>    KeyboardEvent.prototype.getter(&quot;character&quot;, function(){
</span>        return String.fromCharCode(this.keyCode);
    });
    
})();


(function() {
    
    /**
     * @class MouseEvent
     * MouseEvent クラス
     */
    
    /**
     * @property    pointX
     * マウスのX座標.
     */
<span id='MouseEvent-property-pointY'>    MouseEvent.prototype.getter(&quot;pointX&quot;, function() {
</span>        return this.clientX - this.target.getBoundingClientRect().left;
//        return this.pageX - this.target.getBoundingClientRect().left - window.scrollX;
    });
    
    /**
     * @property    pointY
     * マウスのY座標.
     */
    MouseEvent.prototype.getter(&quot;pointY&quot;, function() {
<span id='TouchEvent'>        return this.clientY - this.target.getBoundingClientRect().top;
</span><span id='TouchEvent-property-pointX'>//        return this.pageY - this.target.getBoundingClientRect().top - window.scrollY;
</span>    });
    
})();




(function() {
    
    if (window.TouchEvent === undefined) { return ; }
    
    
    /**
     * @class TouchEvent
     * TouchEvent クラス
     */
    
    /**
     * @property    pointX
     * タッチイベント.
     */
<span id='TouchEvent-property-pointY'>    TouchEvent.prototype.getter(&quot;pointX&quot;, function() {
</span>        return this.touches[0].clientX - this.target.getBoundingClientRect().left;
//        return this.touches[0].pageX - this.target.getBoundingClientRect().left - tm.global.scrollX;
    });
    
    /**
     * @property    pointY
     * タッチイベント.
     */
<span id='tm-dom-Event'>    TouchEvent.prototype.getter(&quot;pointY&quot;, function() {
</span>        return this.touches[0].clientY - this.target.getBoundingClientRect().top;
<span id='tm-dom-Event-property-funcList'><span id='tm-dom-Event-property-element'>//        return this.touches[0].pageY - this.target.getBoundingClientRect().top - tm.global.scrollY;
</span></span>    });
    
    
})();


(function() {
    
    /**
     * @class tm.dom.Event
<span id='tm-dom-Event-property-funcIndex'>     * Event クラス
</span>     */
    tm.dom.Event = tm.createClass({

        /**
         * @property
         * DOMエレメント
<span id='tm-dom-Event-method-constructor'>         */
</span>        element     : null,

        /**
         * @property
         * イベント発火時に実行する関数リスト
         */
        funcList    : null,

        /**
         * @property
<span id='tm-dom-Event-property-add'>         * 関数リストのインデックス　未使用？
</span>         */
        funcIndex   : 0,
        
        
        /**
         * @constructor
         * コンストラクタ
         */
        init: function(element) {
            this.element = element;
            this.domElement = element.element;
            this.funcList = {};
        },
        
        /**
         * @property
         * イベントを追加
         */
        add: function(type, fn, id) {
            var self = this;
            var elm  = this.element;
            
            var temp_fn = function(e) {
                // return fn.apply(self, arguments);
                var result = fn.apply(elm, arguments);
                
                if (result === false) {
                    // デフォルトイベントをキャンセル
                    e.preventDefault();
                    e.returnValue = false;  // IE
                    // イベント伝達をキャンセル
                    e.stopPropagation();
                }
                
<span id='tm-dom-Event-property-remove'>                return result;
</span>            }
            
            this._funcIndex = this._funcIndex || 0;
            id = id || this._funcIndex++;
            this.funcList[type] = this.funcList[type] || {};
            this.funcList[type][id] = temp_fn;
            fn._id = id;    // しれっと記録
            
            this.domElement.addEventListener(type, temp_fn, false);
<span id='tm-dom-Event-property-click'>            return this;
</span>        },
        
        /**
         * @property
         * イベントを解除
         */
        remove: function(type, fn_or_id) {
<span id='tm-dom-Event-property-mdlclick'>            var id = (typeof(fn_or_id) === &quot;function&quot;) ? fn_or_id._id : fn_or_id;
</span>            var fn = this.getFunc(type, id);
            
            this.domElement.removeEventListener(type, fn, false);
            delete this.funcList[type][id];
        },
        
        /**
         * @property
<span id='tm-dom-Event-property-pointstart'>         * クリックイベント
</span>         */
        click: function(fn, id) {
            this.add(&quot;click&quot;, fn, id);
            return this;
        },
        
        /**
<span id='tm-dom-Event-property-pointmove'>         * @property
</span>         * @TODO ?
         */
        mdlclick: function(fn, id) {
            var temp_fn = function(e) {
                if (e.button == 1) {
<span id='tm-dom-Event-property-pointend'>                    fn(e);
</span>                }
            }
            this.add(&quot;click&quot;, temp_fn, id);
        },
        
        /**
         * @property
<span id='tm-dom-Event-property-hover'>         * ポインティングスタート
</span>         */
        pointstart: function(fn, id) {
            this.add(tm.dom.Event.POINT_START, fn, id);
        },
        /**
         * @property
<span id='tm-dom-Event-property-one'>         * ポインティング中
</span>         */
        pointmove: function(fn, id) {
            this.add(tm.dom.Event.POINT_MOVE, fn, id);
        },
        /**
         * @property
         * ポインティングエンド
         */
        pointend: function(fn, id) {
            this.add(tm.dom.Event.POINT_END, fn, id);
        },
        
        /**
         * @property
         * ホバーイベント
         */
        hover: function(fn, id) {
            this.add(&quot;mouseover&quot;, fn, id);
<span id='tm-dom-Event-property-toggle'>            return this;
</span>        },
        
        /**
         * @property
         * 一度だけ呼ばれるイベントを登録
         */
        one: function(type, fn, id) {
            var self = this;
            var elm  = this.element;
            
            var temp_fn = function() {
                var result = fn.apply(elm, arguments);
                self.remove(type, temp_fn);
                return result;
            };
            
            this.add(type, temp_fn, id);
            
            return this;
        },
        
        /**
         * @property
         * トグルイベント登録
         */
        toggle: function(type, fn_list) {
            var self = this;
            var elm  = this.element;
            var temp_list = [];
            
            for (var i=0; i&lt;fn_list.length; ++i) {
<span id='tm-dom-Event-property-getFunc'>                var temp_fn = (function(i){
</span>                    return function(){
                        var result = fn_list[i].apply(elm, arguments);
                        
                        if (result !== false) {
                            var index = (i+1)%fn_list.length;
                            self.one(type, temp_list[index]);
                        }
                    }
                })(i);
<span id='tm-dom-Event-property-event'>                temp_list.push(temp_fn);
</span>            }
            
            this.one(type, temp_list[0]);
            
            return this;
        },
        
        /**
         * @property
         * 指定したイベントタイプ &amp; id の関数を取得
         */
        getFunc: function(type, id) {
            return this.funcList[type][id];
        },
        
    });
    
    tm.dom.Event.POINT_START    = (tm.isMobile) ? &quot;touchstart&quot; : &quot;mousedown&quot;;
    tm.dom.Event.POINT_MOVE     = (tm.isMobile) ? &quot;touchmove&quot; : &quot;mousemove&quot;;
    tm.dom.Event.POINT_END      = (tm.isMobile) ? &quot;touchend&quot; : &quot;mouseup&quot;;
    
    
    /**
     * @property    event
     * スタイルクラス
     */
    tm.dom.Element.prototype.getter(&quot;event&quot;, function(){
        return this._event || ( this._event = tm.dom.Event(this) );
    });
    
})();



</pre>
</body>
</html>
