<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/*
 * ajax.js
 */

tm.util = tm.util || {};


(function() {
    
<span id='AJAX_DEFAULT_SETTINGS'>    /**
</span>     * @enum
     * @TODO ?
     * @private
     */
    var AJAX_DEFAULT_SETTINGS = {
<span id='AJAX_DEFAULT_SETTINGS-property-type'>        /** @property type */
</span>        type :&quot;GET&quot;,
<span id='AJAX_DEFAULT_SETTINGS-property-async'>        /** @property async */
</span>        async: true,
<span id='AJAX_DEFAULT_SETTINGS-property-data'>        /** @property data */
</span>        data: null,
<span id='AJAX_DEFAULT_SETTINGS-property-contentType'>        /** @property contentType */
</span>        contentType: 'application/x-www-form-urlencoded',
<span id='AJAX_DEFAULT_SETTINGS-property-dataType'>        /** @property dataType */
</span>        dataType: 'text',
<span id='AJAX_DEFAULT_SETTINGS-property-username'>        /** @property username */
</span>        username: null,
<span id='AJAX_DEFAULT_SETTINGS-property-password'>        /** @property password */
</span>        password: null,
<span id='AJAX_DEFAULT_SETTINGS-property-success'>        /** @property success */
</span>        success : function(data){ alert(&quot;success!!\n&quot;+data); },
<span id='AJAX_DEFAULT_SETTINGS-property-error'>        /** @property error */
</span>        error   : function(data){ alert(&quot;error!!&quot;); }
    };
    
<span id='tm-util-Ajax'>    /**
</span>     * @class tm.util.Ajax
     * @TODO ?
     */
    tm.util.Ajax = {
<span id='tm-util-Ajax-property-load'>        /**
</span>         * @property load
         */
        load: function(params) {
            for (var key in AJAX_DEFAULT_SETTINGS) {
                params[key] = params[key] || AJAX_DEFAULT_SETTINGS[key];
            }
            
            var httpRequest = new XMLHttpRequest();
            var ajax_params = &quot;&quot;;
            var conv_func = tm.util.Ajax.DATA_CONVERTE_TABLE[params.dataType];
            
            // コールバック
            httpRequest.onreadystatechange = function() {
                if (httpRequest.readyState == 4) {
                    // 成功
                    if (httpRequest.status === 200) {
                        // タイプ別に変換をかける
                        var data = conv_func(httpRequest.responseText);
                        params.success(data);
                    }
                    // status === 0 はローカルファイル用
                    else if (httpRequest.status === 0) {
                        // タイプ別に変換をかける
                        var data = conv_func(httpRequest.responseText);
                        params.success(data);
                    }
                    else {
                        params.error(httpRequest.responseText);
                    }
                }
                else {
                    //console.log(&quot;通信中&quot;);
                }
            };
            
            httpRequest.open(params.type, params.url, params.async, params.username, params.password);   // オープン
<span id='tm-util-Ajax-property-loadJSONP'>            httpRequest.setRequestHeader('Content-Type', params.contentType);        // ヘッダをセット
</span>            httpRequest.send(null);
        },
        
        /**
         * @property loadJSONP
         */
        loadJSONP: function(url, callback) {
            var g = tm.global;
            g.tmlib_js_dummy_func_count = tm.global.tmlib_js_dummy_func || 0;
            var dummy_func_name = &quot;tmlib_js_dummy_func&quot; + (g.tmlib_js_dummy_func_count++);
            g[dummy_func_name]  = callback;
            
            var elm = document.createElement(&quot;script&quot;);
            elm.type = &quot;text/javascript&quot;;
            elm.charset = &quot;UTF-8&quot;;
            elm.src = url + &quot;&amp;callback=&quot; + dummy_func_name;
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE'>            elm.setAttribute(&quot;defer&quot;, true);
</span>            document.getElementsByTagName(&quot;head&quot;)[0].appendChild(elm);
        }
    };
    
    /**
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-undefined'>     * @enum tm.util.Ajax.DATA_CONVERTE_TABLE
</span>     * データコンバータテーブル
     */
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-text'>    tm.util.Ajax.DATA_CONVERTE_TABLE = {
</span>        /** @property */
        undefined: function(data) {
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-xml'>            return data;
</span>        },
        
        /** @property */
        text: function(data) {
            return data;
        },
        
        /** @property */
        xml: function(data) {
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-dom'>            var div = document.createElement(&quot;div&quot;);
</span>            div.innerHTML = data;
            return div;
        },
        
        /** @property */
        dom: function(data) {
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-json'>            var div = document.createElement(&quot;div&quot;);
</span>            div.innerHTML = data;
            return tm.dom.Element(div);
        },
        
        /** @property */
        json: function(data) {
            try {
                return JSON.parse(data);
            }
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-script'>            catch(e) {
</span>                console.dir(e);
                console.dir(data);
            }
        },
        
<span id='tm-util-Ajax-DATA_CONVERTE_TABLE-property-bin'>        /** @property */
</span>        script: function(data) {
            eval(data);
            return data;
        },
        
        /**
         * @property
         * ### Reference
         * - &lt;http://efcl.info/adiary/Javascript/treat-binary&gt;
         * @param {Object} data
         */
        bin: function(data) {
            var bytearray = [];
            for (var i=0, len=data.length; i&lt;len; ++i) {
                bytearray[i] = data.charCodeAt(i) &amp; 0xff;
            }
            return bytearray;
        },
        
    };
    
})();
</pre>
</body>
</html>
